# 自动错误上报与通义大模型集成说明

## 功能概览
已集成 `auto_issue_reporter.py`：
- 捕获入口 `main()` 运行期未处理异常
- 结构化记录错误 -> `AI/error_reports/error_log.jsonl`
- 15 分钟内相同错误去重（错误类型+定位+首行trace）
- 可选启用外部 AI (通义) 占位上报：写入 `ai_suggestions.jsonl`
- 上下文脱敏：自动屏蔽 token / password / api_key 字段

## 启动方式
默认仅本地记录。若要开启外部占位 AI 逻辑（不会真正调用通义，需自行补充 API 请求）：
```bash
export AUTO_AI_REPORT=1
export TONGYI_API_KEY="你的通义API密钥"  # 可选
streamlit run enhanced_app.py --server.port=8504
```
> Windows PowerShell:
```powershell
$Env:AUTO_AI_REPORT=1
$Env:TONGYI_API_KEY="你的通义API密钥"
streamlit run enhanced_app.py --server.port=8504
```

## 目录结构
```
AI/
  auto_issue_reporter.py
  error_reports/
    error_log.jsonl          # 逐条JSON错误记录
    sent_cache.json          # 去重窗口缓存
    ai_suggestions.jsonl     # 占位AI建议
```

## JSONL 错误记录示例
```json
{"timestamp_utc":"2025-11-06T07:10:22.123456","section":"MAIN_ENTRY","error_type":"TypeError","error_message":"'<' not supported ...","location_hint":"File '.../spssau_renderer.py', line 127","context":{}}
```

## 二次开发建议
| 目标 | 建议做法 |
|------|----------|
| 真正调用通义模型 | 在 `_attempt_external_ai` 中加入 `requests.post` 并解析返回建议 |
| 批量合并发送 | 增加内存队列 + 定时线程 flush |
| 敏感数据脱敏 | 增加字段正则匹配 (手机号/邮箱) 替换星号 |
| UI 集成 | 在侧边栏加“错误日志”查看器，读取 `error_log.jsonl` |
| 自动修复建议展示 | 解析 AI 返回 JSON 中的 `fix_patch`，渲染 diff |

## 与现有代码更深集成
可以在各步骤函数外层增加装饰器：
```python
from auto_issue_reporter import ai_error_guard

@ai_error_guard("STEP1_TEMPLATE")
def render_step_1_template_upload():
    ...
```
当前仅对 `main()` 顶层包装，已足够捕获绝大多数未处理异常；若希望更细粒度分区，请添加装饰器。

## 通义调用占位说明
当前 `_attempt_external_ai`：
- 检测 `TONGYI_API_KEY` 存在则写入一条占位建议
- 不发起网络请求（保证离线安全）
- 你可以在此函数中加入真实逻辑，例如：
```python
import requests
API_URL = "https://dashscope.aliyuncs.com/api/v1/services/..."
resp = requests.post(API_URL, headers={"Authorization": f"Bearer {api_key}"}, json={"input": record})
```

## 错误去重策略
- Key = sha256(错误类型 + 位置行文本 + trace 最后一行)
- 命中则 15 分钟内不重复外部上报（仍写入本地 error_log.jsonl 以保证审计完备）

## 安全提示
- 勿直接上传完整原始数据到外部AI；仅传最小复现上下文
- 避免包含用户隐私、API密钥、数据库连接串
- 可在 `_sanitize_context` 中扩充敏感关键词列表

## 下一步可选增强
1. 提供 Web 面板用于筛选、搜索、导出错误
2. 增加统计：错误类型 TopN、最近 24h 趋势
3. 生成自动“每天错误日报” Markdown
4. 集成 Slack/飞书/钉钉推送
5. 对常见错误建立自动修复脚本（例如 p 值解析问题）

---
如需我继续：
- “细化捕获” => 为各步骤函数添加装饰器
- “添加错误面板” => 我来实现侧边栏查看器
- “接入真实通义” => 需提供正式 API 规格
回复关键字即可。